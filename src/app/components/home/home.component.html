<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport"    content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author"      content="Mike Pasek">

  <title>Aggregatr</title>

  <!--<link rel="shortcut icon" href="assets/images/gt_favicon.png">-->

  <!-- Bootstrap itself -->
  <!--<link href="../../../public/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">-->
  <link href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet" type="text/css">

  <!-- Fonts -->
  <!--<link href="../../../public/lib/font-awesome/web-fonts-with-css/css/font-awesome.min.css" rel="stylesheet" type="text/css">-->
  <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <!--<link href='http://fonts.googleapis.com/css?family=Wire+One' rel='stylesheet' type='text/css'>-->
  <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
</head>

<!-- use "theme-invert" class on bright backgrounds, also try "text-shadows" class -->
<body class="theme-invert">

<!-- Main (Home) section -->
<section class="section" id="head">
  <div class="container">

    <div class="row">
      <div class="col-md-10 col-lg-10 col-md-offset-1 col-lg-offset-1 text-center">

        <!-- Site Title, your name, HELLO msg, etc. -->
        <h1 class="title">AGGREGATR</h1>
        <h2 class="subtitle">Aggregating your saved Spotify tracks into playlists</h2>

        <!-- Short introductory (optional) -->
        <h3 class="tagline">
          Have you saved too many tracks on Spotify and forget about ones you've saved months, or even years, ago?<br>
          This app allows you to generate playlists for your saved tracks based on the date it was added.
        </h3>

        <!-- Nice place to describe your site in a sentence or two -->
        <p><a href="http://localhost:3000/login" class="btn btn-default btn-lg">Log in with Spotify</a></p>

      </div> <!-- /col -->
    </div> <!-- /row -->

  </div>
</section>



<!-- Load js libs only when the page is loaded. -->
<script src="../../../public/lib/jquery/dist/jquery.min.js"></script>
<script src="../../../public/lib/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="../../assets/js/modernizr.custom.72241.js"></script>

<!--<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>-->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
<script>
  (function() {

    /**
     * Obtains parameters from the hash of the URL
     * @return Object
     */
    function getHashParams() {
      var hashParams = {};
      var e, r = /([^&;=]+)=?([^&;]*)/g,
        q = window.location.hash.substring(1);
      while ( e = r.exec(q)) {
        hashParams[e[1]] = decodeURIComponent(e[2]);
      }
      return hashParams;
    }

    var userProfileSource = document.getElementById('user-profile-template').innerHTML,
      userProfileTemplate = Handlebars.compile(userProfileSource),
      userProfilePlaceholder = document.getElementById('user-profile');

    var oauthSource = document.getElementById('oauth-template').innerHTML,
      oauthTemplate = Handlebars.compile(oauthSource),
      oauthPlaceholder = document.getElementById('oauth');

    var params = getHashParams();

    var access_token = params.access_token,
      refresh_token = params.refresh_token,
      error = params.error;

    if (error) {
      alert('There was an error during the authentication');
    } else {
      if (access_token) {
        // render oauth info
        oauthPlaceholder.innerHTML = oauthTemplate({
          access_token: access_token,
          refresh_token: refresh_token
        });

        $.ajax({
          url: 'https://api.spotify.com/v1/me',
          headers: {
            'Authorization': 'Bearer ' + access_token
          },
          success: function(response) {
            userProfilePlaceholder.innerHTML = userProfileTemplate(response);

            $('#login').hide();
            $('#loggedin').show();
          }
        });
      } else {
        // render initial screen
        $('#login').show();
        $('#loggedin').hide();
      }

      document.getElementById('obtain-new-token').addEventListener('click', function() {
        $.ajax({
          url: '/refresh_token',
          data: {
            'refresh_token': refresh_token
          }
        }).done(function(data) {
          access_token = data.access_token;
          oauthPlaceholder.innerHTML = oauthTemplate({
            access_token: access_token,
            refresh_token: refresh_token
          });
        });
      }, false);
    }
  })();
</script>


<!-- Custom template scripts -->
<script src="../../../assets/js/magister.js"></script>
</body>
</html>
